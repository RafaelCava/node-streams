<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>webstream Ã© o terrooorr</title>
    <style>
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        grid-gap: 20px;
        align-items: stretch;
      }
      .grid > article {
        border: 1px solid #ccc;
      }

      .grid .text {
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <button id="start">Start</button>
    <button id="stop">Stop</button>
    <div class="container">
      <main id="cards" class="grid"></main>
    </div>
    <script type="module">
      const API_URL = "http://localhost:3000";

      async function consumeAPI(signal) {
        const response = await fetch(API_URL, {
          signal,
        });
        let counter = 0;
        const reader = response.body
          .pipeThrough(new TextDecoderStream())
          .pipeThrough(parseNDJSON());
        // .pipeTo(
        //   new WritableStream({
        //     write(chunk) {
        //       console.log(++counter, chunk, "chunk");
        //     },
        //   })
        // );
        return reader;
      }

      function appendToHTML(element) {
        return new WritableStream({
          write({ title, description, url_anime }) {
            const card = `
            <article>
              <div class="text">
                <h3>${title}</h3>
                <p>${description.slice(0, 100)}</p>
                <a href="${url_anime}">Here's why</a>
              </div>
            </article>
          `;
            element.innerHTML += card;
          },
          abort(reason) {
            console.log("abortou", reason);
          },
        });
      }

      function parseNDJSON(data) {
        let ndjsonBuffer = "";
        return new TransformStream({
          transform(chunk, controller) {
            ndjsonBuffer += chunk;
            const items = ndjsonBuffer.split("\n");
            items
              .slice(0, -1)
              .forEach((item) => controller.enqueue(JSON.parse(item)));
            ndjsonBuffer = items[items.length - 1];
          },
          flush(controller) {
            if (!ndjsonBuffer) return;
            controller.enqueue(JSON.parse(ndjsonBuffer));
          },
        });
      }

      const [start, stop, cards] = ["start", "stop", "cards"].map((item) =>
        document.getElementById(item)
      );

      let abortController = new AbortController();
      start.addEventListener("click", async () => {
        cards.innerHTML = "";
        const readable = await consumeAPI(abortController.signal);
        readable.pipeTo(appendToHTML(cards));
      });
      stop.addEventListener("click", () => {
        abortController.abort();
        abortController = new AbortController();
      });
    </script>
  </body>
</html>
